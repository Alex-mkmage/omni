<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2013 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>

<?php
$_product    = $this->getProduct();
$_attributes = Mage::helper('core')->decorateArray($this->getAllowAttributes());
?>
<?php if ($_product->isSaleable() && count($_attributes)):?>
    <dl>
        <?php foreach($_attributes as $_attribute): ?>
            <dt class="blue-text"><label class="required">
                    <?php echo $_attribute->getLabel() ?></label>
            </dt>
            <dd<?php if ($_attribute->decoratedIsLast){?> class="last"<?php }?>>
                <div class="input-box">
                    <?php $attrCount = $_attribute->getPrices() ?>
                    <?php if(count($attrCount) > 2): ?>
                        <select name="super_attribute[<?php echo $_attribute->getAttributeId() ?>]" id="attribute<?php echo $_attribute->getAttributeId() ?>" class="required-entry super-attribute-select">
                            <option><?php echo $this->__('Choose an Option...') ?></option>
                        </select>
                    <?php else: ?>
                        <div style="display:none">
                            <select name="super_attribute[<?php echo $_attribute->getAttributeId() ?>]" id="attribute<?php echo $_attribute->getAttributeId() ?>" class="required-entry super-attribute-select">
                                <option><?php echo $this->__('Choose an Option...') ?></option>
                            </select>
                        </div>
                        <?php $configs = $this->getRegularConfig()?>
                        <?php $configBlock = $this->getLayout()
                            ->createBlock('easylife_switcher/catalog_product_view_type_configurable_config') ?>
                        <?php $defaultValues = $configBlock->getDefaultValues()?>
                        <?php foreach($configs['attributes'] as $config):?>
                            <?php foreach($config['options'] as $value):?>
                                <label class="label-radio-configurable" id="<?php echo (float)$value['price'] + (float) $_product->getPrice();?>">
                                    <input type="radio" name="radio_config[<?php echo $_attribute->getAttributeId() ?>]"
                                           data-target="attribute<?php echo $_attribute->getAttributeId() ?>"
                                        <?php if(isset($defaultValues[$_attribute->getAttributeId()])): ?>
                                            <?php if($defaultValues[$_attribute->getAttributeId()] == $value['id']): ?>
                                                checked
                                            <?php endif; ?>
                                        <?php endif; ?>
                                           class="radioConfig validate-custom-configurable"
                                           value="<?php echo $value['id'] ?>"/>
                                    <?php echo $value['label']?>
                                    <?php $child = Mage::getModel('catalog/product')->load($value['products'][0]); ?>
                                    <span class="sku">(<?php echo $child->getSku() ?>)</span>
                                    <span class="price">
                                        <?php if($value['price'] > 0): ?>+ $<?php printf("%.2f",
                                            $value['price'])?> <?php endif; ?>
                                    </span>
                                </label>
                            <?php endforeach;?>
                        <?php endforeach;?>
                    <?php endif; ?>
                </div>
            </dd>
        <?php endforeach; ?>
    </dl>
    <script type="text/javascript">
        var spConfig = new Product.Config(<?php echo $this->getJsonConfig() ?>);
        document.observe("dom:loaded", function() {
            var customValidation = false;
            var priceFormat = <?php echo $this->helper('tax')->getPriceFormat(); ?>;
            $$('.validate-custom-configurable').each(function(el){
                el.observe('click',function(event){
                    //console.log(el.parentNode);
                    $$('.add-to-cart span .price').each(function(elmn){
                        elmn.update(formatCurrency(parseFloat(el.parentNode.id), priceFormat)).innerHTML;
                    });
                });
            });
            Validation.addAllThese([
                ['validate-custom-configurable', 'This is a required field.', function(v) {
                    $$('.validate-custom-configurable').each(function(el){
                        if (el.checked) {
                            customValidation = true;
                        }
                    });
                    return customValidation;
                }]
            ]);
        });

        jQuery(function ($) {
            $('.radioConfig').click(function(){
                if($(this).is(':checked')){
                    $('#'+$(this).data('target')).val($(this).val());
                }
            });
        });
    </script>
<?php endif;?>
